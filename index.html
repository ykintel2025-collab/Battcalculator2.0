<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thuisbatterij Calculator v5.1 | Exclupower</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f0f4f8; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; box-sizing: border-box; }
        .container { max-width: 1200px; width: 100%; background-color: #ffffff; padding: 40px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h1, h2, h3 { text-align: center; color: #1e3a5f; }
        .main-grid { display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
        .settings-panel .setting-step { background-color: #f9fbfd; padding: 20px; border-radius: 12px; border: 1px solid #e0e6ed; margin-bottom: 20px; }
        .setting-step h3 { text-align: left; margin-top: 0; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .results-panel { display: flex; flex-direction: column; gap: 20px; }
        .result-card { background-color: #f9fbfd; padding: 20px; border-radius: 12px; border: 1px solid #e0e6ed; }
        .main-recommendation { text-align: center; background-color: #eaf9ed; }
        .setting-row { display: flex; flex-direction: column; align-items: stretch; margin-bottom: 15px; }
        .setting-row label { font-weight: 500; margin-bottom: 5px; text-align: left; }
        .setting-row select, .setting-row input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #e0e6ed; background-color: white; font-size: 1em; box-sizing: border-box; }
        .hidden { display: none; }
        .chart-canvas-container { position: relative; height: 400px; width: 100%; margin-top: 10px; }
        .chart-controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 15px; padding: 10px; background-color: #f0f4f8; border-radius: 8px; }
        .control-group label { display: flex; align-items: center; font-size: 0.9em; cursor: pointer; }
        .control-group input { margin-right: 5px; }
        #capaciteitResultaat { font-size: 2.5em; color: #27ae60; font-weight: 700; display: block; margin-top: 10px; }
        .costs-table { width: 100%; margin-top: 15px; font-size: 0.95em; border-collapse: collapse; }
        .costs-table td { padding: 8px; border-bottom: 1px solid #e0e6ed; }
        .costs-table td:last-child { font-weight: 700; text-align: right; }
        .costs-table tr:last-child td { border-bottom: none; }
        .total-savings { font-size: 1.2em; font-weight: bold; color: #27ae60; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Thuisbatterij Advies Wizard v5.1</h1>
        <div class="main-grid">
            <div class="settings-panel">
                <div class="setting-step">
                    <h3>Stap 1: Uw Verbruik</h3>
                    <div class="setting-row">
                        <label for="verbruikSelect">Basisverbruik huishouden</label>
                        <select id="verbruikSelect"><option value="2500">1-2 Personen (~2500 kWh)</option><option value="3500" selected>3-4 Personen (~3500 kWh)</option><option value="5000">5+ Personen (~5000 kWh)</option></select>
                    </div>
                    <div class="setting-row">
                        <label for="evSelect">Elektrische auto</label>
                        <select id="evSelect"><option value="0">Nee</option><option value="1800">Ja, tot 10.000 km/j</option><option value="3600">Ja, 10-20.000 km/j</option><option value="5400">Ja, 20.000+ km/j</option></select>
                    </div>
                    <div id="ev-laadtijd-container" class="setting-row hidden">
                        <label for="evLaadtijd">Wanneer laadt u meestal op?</label>
                        <select id="evLaadtijd"><option value="nacht">'s Nachts</option><option value="dag">Overdag</option></select>
                    </div>
                    <div class="setting-row">
                        <label for="wpSelect">Warmtepomp</label>
                        <select id="wpSelect"><option value="0">Nee</option><option value="1500">Ja, in appartement</option><option value="2500">Ja, in tussenwoning</option><option value="3500">Ja, in hoekwoning</option><option value="4500">Ja, in vrijstaand huis</option></select>
                    </div>
                </div>
                <div class="setting-step">
                    <h3>Stap 2: Zonnepanelen</h3>
                    <div class="setting-row">
                        <label for="aantalPanelen">Aantal zonnepanelen</label>
                        <input type="number" id="aantalPanelen" value="12">
                    </div>
                </div>
                <div class="setting-step">
                    <h3>Stap 3: Energiecontract</h3>
                    <div class="setting-row">
                        <label for="contractType">Huidig energiecontract</label>
                        <select id="contractType"><option value="vast">Vast / Variabel</option><option value="dynamisch">Dynamisch</option></select>
                    </div>
                </div>
            </div>
            <div class="results-panel">
                <div id="recommendation-card" class="result-card main-recommendation">
                    <h2 style="margin-top:0;">Uw Aanbevolen Batterij</h2>
                    <strong id="capaciteitResultaat">- kWh</strong>
                </div>
                <div id="financial-card" class="result-card">
                    <h3>Uw Geschatte Jaarlijkse Energiekosten</h3>
                    <table class="costs-table">
                        <tbody>
                            <tr><td>Huidige situatie (zonder batterij)</td><td id="costs-current">-</td></tr>
                            <tr><td>Met thuisbatterij</td><td id="costs-with-battery">-</td></tr>
                            <tr class="total-savings"><td>Uw jaarlijkse besparing</td><td id="savings-total">-</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="charts-container" class="result-card">
                    <h3 id="chart-title">Uw Energieprofiel (24 uur)</h3>
                    <div class="chart-canvas-container"><canvas id="scenarioChartCanvas"></canvas></div>
                    <div class="chart-controls">
                        <div class="control-group"><label><input type="checkbox" id="toggle-opbrengst" checked> Opbrengst</label></div>
                        <div class="control-group"><label><input type="checkbox" id="toggle-verbruik" checked> Verbruik</label></div>
                        <div class="control-group"><label><input type="checkbox" id="toggle-batterij" checked> Batterij Acties</label></div>
                        <div class="control-group"><label><input type="checkbox" id="toggle-export" checked> Export</label></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let scenarioChart;

        // --- DATA PROFIELEN EN PRIJZEN ---
        const E1A_PROFIEL = [0.033,0.027,0.024,0.022,0.023,0.03,0.043,0.055,0.052,0.045,0.04,0.039,0.038,0.037,0.036,0.038,0.047,0.06,0.065,0.063,0.06,0.055,0.05,0.043];
        const WARMTEPOMP_PROFIEL = [0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.04,0.03,0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.03,0.04,0.05,0.05,0.06,0.06,0.05,0.05];
        const ZONNEPROFIEL = [0,0,0,0,0,0,0.01,0.03,0.06,0.09,0.11,0.13,0.14,0.13,0.12,0.09,0.05,0.03,0,0,0,0,0,0];
        const VAST_TARIEF = 0.35;
        const TERUGLEVER_TARIEF = 0.08;
        const DYNAMISCHE_PRIJZEN = [0.15,0.14,0.13,0.12,0.13,0.16,0.20,0.25,0.24,0.22,0.20,0.19,0.21,0.23,0.24,0.28,0.34,0.38,0.40,0.37,0.32,0.28,0.24,0.20];

        // --- INITIALISATIE ---
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('select, input[type=number], .control-group input').forEach(el => {
                el.addEventListener('change', recalculateAndRedraw);
            });
            recalculateAndRedraw();
        });

        // --- HOOFDLOGICA ---
        function recalculateAndRedraw() {
            const state = getCurrentState();
            manageVisibility(state);
            const calculations = calculateAll(state);
            updateUI(state, calculations);
        }

        function getCurrentState() {
            return { 
                basisVerbruikKwh: parseInt(document.getElementById('verbruikSelect').value),
                evVerbruikKwh: parseInt(document.getElementById('evSelect').value),
                evLaadtijd: document.getElementById('evLaadtijd').value,
                wpVerbruikKwh: parseInt(document.getElementById('wpSelect').value),
                aantalPanelen: parseInt(document.getElementById('aantalPanelen').value) || 0,
                contractType: document.getElementById('contractType').value,
                show: {
                    opbrengst: document.getElementById('toggle-opbrengst').checked,
                    verbruik: document.getElementById('toggle-verbruik').checked,
                    batterij: document.getElementById('toggle-batterij').checked,
                    export: document.getElementById('toggle-export').checked,
                }
            };
        }

        function manageVisibility(state) {
            document.getElementById('ev-laadtijd-container').classList.toggle('hidden', state.evVerbruikKwh === 0);
        }

        function calculateAll(state) {
            const DOD = 0.95, RENDEMENT = 0.90, WP_PER_PANEEL = 400;
            const basisVerbruikPerUur = E1A_PROFIEL.map(p => (state.basisVerbruikKwh / 365) * p);
            const evVerbruikPerUur = new Array(24).fill(0);
            if (state.evVerbruikKwh > 0) {
                const dagelijksEvVerbruik = state.evVerbruikKwh / 365;
                const laaduren = 6; const laadvermogen = dagelijksEvVerbruik / laaduren;
                if (state.evLaadtijd === 'nacht') {
                    for (let i = 22; i < 24; i++) evVerbruikPerUur[i] = laadvermogen;
                    for (let i = 0; i < 4; i++) evVerbruikPerUur[i] = laadvermogen;
                } else {
                    for (let i = 10; i < 16; i++) evVerbruikPerUur[i] = laadvermogen;
                }
            }
            const wpVerbruikPerUur = WARMTEPOMP_PROFIEL.map(p => (state.wpVerbruikKwh / 365) * p);
            const geschaaldVerbruik = new Array(24).fill(0);
            for (let i = 0; i < 24; i++) { geschaaldVerbruik[i] = basisVerbruikPerUur[i] + evVerbruikPerUur[i] + wpVerbruikPerUur[i]; }
            
            let geschaaldeOpbrengst = new Array(24).fill(0);
            if(state.aantalPanelen > 0){
                const totaalWp = state.aantalPanelen * WP_PER_PANEEL;
                const dagelijkseOpbrengstZonnig = (totaalWp * 5) / 1000;
                geschaaldeOpbrengst = ZONNEPROFIEL.map(p => p * dagelijkseOpbrengstZonnig);
            }
            
            const maximaalOverschot = geschaaldeOpbrengst.reduce((sum, o, i) => sum + Math.max(0, o - geschaaldVerbruik[i]), 0);
            let nachtelijkVerbruik = 0;
            for (let i = 19; i < 24; i++) { nachtelijkVerbruik += geschaaldVerbruik[i]; }
            for (let i = 0; i < 7; i++) { nachtelijkVerbruik += geschaaldVerbruik[i]; }
            const benodigdeCapaciteit = Math.min(nachtelijkVerbruik / (DOD * RENDEMENT), maximaalOverschot / RENDEMENT);
            const aanbevolenCapaciteit = Math.max(5, Math.ceil(benodigdeCapaciteit / 5) * 5);
            
            return { aanbevolenCapaciteit, geschaaldVerbruik, geschaaldeOpbrengst };
        }
        
        function updateUI(state, calcs){
            document.getElementById('capaciteitResultaat').textContent = `${calcs.aanbevolenCapaciteit.toFixed(1)} kWh`;
            
            const simZonderBatterij = simulateDay(calcs.geschaaldVerbruik, calcs.geschaaldeOpbrengst, 0, state.contractType);
            const simMetBatterij = simulateDay(calcs.geschaaldVerbruik, calcs.geschaaldeOpbrengst, calcs.aanbevolenCapaciteit, state.contractType);

            const kostenHuidig = simZonderBatterij.dagKosten * 365;
            const kostenNieuw = simMetBatterij.dagKosten * 365;
            const besparing = kostenHuidig - kostenNieuw;

            document.getElementById('costs-current').textContent = `€ ${Math.round(kostenHuidig).toLocaleString('nl-NL')}`;
            document.getElementById('costs-with-battery').textContent = `€ ${Math.round(kostenNieuw).toLocaleString('nl-NL')}`;
            document.getElementById('savings-total').textContent = `€ ${Math.round(besparing).toLocaleString('nl-NL')}`;
            
            renderScenarioChart(simMetBatterij, calcs, state.show);
        }

        function simulateDay(verbruikData, opbrengstData, batterijCapaciteit, contractType) {
            const MAX_RATE_KW = 5;
            const DOD = 0.95;
            let batterijLading = 0;
            const bruikbareCapaciteit = batterijCapaciteit * DOD;
            let dagKosten = 0;
            const result = { importData:[], exportData:[], battLaadData:[], battOntlaadData:[], directVerbruikData:[]};

            for (let i = 0; i < 24; i++) {
                let verbruik = verbruikData[i], opbrengst = opbrengstData[i];
                let importVanNet = 0, exportNaarNet = 0, ladingNaarBatterij = 0, ontladingUitBatterij = 0;

                if (contractType === 'dynamisch' && DYNAMISCHE_PRIJZEN[i] < 0.15 && opbrengst < 0.01) {
                    const kanLaden = bruikbareCapaciteit - batterijLading;
                    const lading = Math.min(kanLaden, MAX_RATE_KW);
                    batterijLading += lading;
                    importVanNet += lading;
                }

                const directGebruik = Math.min(verbruik, opbrengst);
                verbruik -= directGebruik;
                opbrengst -= directGebruik;
                
                if (opbrengst > 0) {
                    const kanNogLaden = bruikbareCapaciteit - batterijLading;
                    ladingNaarBatterij = Math.min(opbrengst, MAX_RATE_KW, kanNogLaden);
                    batterijLading += ladingNaarBatterij;
                    exportNaarNet = opbrengst - ladingNaarBatterij;
                } else if (verbruik > 0) {
                    const kanOntladen = batterijLading;
                    let ontladenToegestaan = true;
                    if (contractType === 'dynamisch' && DYNAMISCHE_PRIJZEN[i] < 0.25) {
                        ontladenToegestaan = false;
                    }
                    if (ontladenToegestaan) {
                        ontladingUitBatterij = Math.min(verbruik, MAX_RATE_KW, kanOntladen);
                        batterijLading -= ontladingUitBatterij;
                    }
                    importVanNet += (verbruik - ontladingUitBatterij);
                }
                
                dagKosten += (importVanNet * (contractType === 'dynamisch' ? DYNAMISCHE_PRIJZEN[i] : VAST_TARIEF));
                dagKosten -= (exportNaarNet * TERUGLEVER_TARIEF);

                result.directVerbruikData.push(directGebruik);
                result.battOntlaadData.push(ontladingUitBatterij);
                result.importData.push(importVanNet);
                result.battLaadData.push(ladingNaarBatterij);
                result.exportData.push(exportNaarNet);
            }
            result.dagKosten = dagKosten;
            return result;
        }

        function renderScenarioChart(sim, calcs, show) {
            const ctx = document.getElementById('scenarioChartCanvas')?.getContext('2d');
            if (!ctx) return;
            
            const dataMultiplier = 1000;
            const datasets = [];

            if (show.opbrengst) {
                 datasets.push({ type: 'line', label: 'Zon-opbrengst', data: calcs.geschaaldeOpbrengst.map(d=>d*dataMultiplier), borderColor: 'rgba(241, 196, 15, 0.8)', backgroundColor: 'rgba(241, 196, 15, 0.1)', fill: true, pointRadius: 0, borderWidth: 2 });
            }
            if (show.verbruik) {
                 datasets.push({ label: 'Verbruik: Direct van Zon', data: sim.directVerbruikData.map(d=>d*dataMultiplier), backgroundColor: 'rgba(46, 204, 113, 0.7)', stack: 'verbruik' });
                 datasets.push({ label: 'Verbruik: Uit Batterij', data: sim.battOntlaadData.map(d=>d*dataMultiplier), backgroundColor: 'rgba(52, 152, 219, 0.7)', stack: 'verbruik' });
                 datasets.push({ label: 'Verbruik: Import van Net', data: sim.importData.map(d=>d*dataMultiplier), backgroundColor: 'rgba(231, 76, 60, 0.7)', stack: 'verbruik' });
            }
            if (show.batterij) {
                 datasets.push({ label: 'Laden Batterij', data: sim.battLaadData.map(d=>d*dataMultiplier), backgroundColor: 'rgba(243, 156, 18, 0.7)' });
            }
            if(show.export) {
                 datasets.push({ label: 'Export naar Net', data: sim.exportData.map(d=>d*dataMultiplier), backgroundColor: 'rgba(155, 89, 182, 0.6)' });
            }
            
            if (scenarioChart) scenarioChart.destroy();
            scenarioChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: datasets
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        x: { stacked: true, grid: { display: false } }, 
                        y: { stacked: true, title: { display: true, text: 'Energie (Wh)' } }
                    }
                }
            });
        }
    </script>
</body>
</html>
